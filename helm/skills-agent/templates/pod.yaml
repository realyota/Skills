{{- if .Values.debugMode }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "skills-agent.fullname" . }}-debug
  labels:
    {{- include "skills-agent.labels" . | nindent 4 }}
    skills-agent/skill: {{ .Values.skillName | quote }}
    skills-agent/agent: {{ .Values.agent | quote }}
    skills-agent/mode: "debug"
spec:
  {{- with .Values.imagePullSecrets }}
  imagePullSecrets:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  serviceAccountName: {{ include "skills-agent.serviceAccountName" . }}
  restartPolicy: Never
  containers:
    - name: agent
      image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
      imagePullPolicy: {{ .Values.image.pullPolicy }}
      command:
        - /bin/sh
        - -c
        - |
          echo "Debug mode enabled - pod will sleep indefinitely"
          echo "Connect with: kubectl exec -it {{ include "skills-agent.fullname" . }}-debug -- /bin/sh"
          echo ""
          echo "To run the agent manually:"
          echo "  cd /workspace"
          {{- if eq .Values.agent "claude" }}
          echo "  mkdir -p /home/bun/.claude"
          echo "  cp /secrets/claude-credentials.json /home/bun/.claude/.credentials.json"
          echo "  chmod 600 /home/bun/.claude/.credentials.json"
          echo "  claude --dangerously-skip-permissions -p \"/{{ .Values.skillName }} {{ .Values.prompt }}\""
          {{- else if eq .Values.agent "codex" }}
          echo "  mkdir -p /home/bun/.codex"
          echo "  cp /secrets/codex-auth.json /home/bun/.codex/auth.json"
          echo "  chmod 600 /home/bun/.codex/auth.json"
          echo "  codex --dangerously-skip-permissions \"\${{ .Values.skillName }} {{ .Values.prompt }}\""
          {{- end }}
          echo ""
          sleep infinity
      env:
        - name: HOME
          value: /home/bun
        {{- if and .Values.storeResults.enabled (not .Values.storeResults.iamRoleArn) }}
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: {{ include "skills-agent.fullname" . }}-aws-credentials
              key: aws-access-key-id
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ include "skills-agent.fullname" . }}-aws-credentials
              key: aws-secret-access-key
        - name: AWS_DEFAULT_REGION
          value: {{ .Values.storeResults.awsRegion | quote }}
        {{- end }}
        {{- with .Values.extraEnv }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      resources:
        {{- toYaml .Values.resources | nindent 8 }}
      volumeMounts:
        - name: credentials
          mountPath: /secrets
          readOnly: true
        - name: workspace
          mountPath: /workspace
        - name: agent-logs
          mountPath: /tmp/agent-logs
        - name: clickhouse-client-config
          mountPath: /etc/clickhouse-client/config.xml
          subPath: clickhouse-client-config.xml
          readOnly: true
        - name: altinity-mcp-config
          mountPath: /etc/altinity-mcp/config.yaml
          subPath: altinity-mcp-config.yaml
          readOnly: true
        {{- if .Values.clickhouse.tls.ca }}
        - name: clickhouse-tls-ca
          mountPath: /etc/clickhouse-client/ca.crt
          subPath: clickhouse-ca.crt
          readOnly: true
        - name: clickhouse-tls-ca
          mountPath: /etc/altinity-mcp/ca.crt
          subPath: clickhouse-ca.crt
          readOnly: true
        {{- end }}
        {{- if .Values.clickhouse.tls.cert }}
        - name: clickhouse-tls-cert
          mountPath: /etc/clickhouse-client/client.crt
          subPath: clickhouse-client.crt
          readOnly: true
        - name: clickhouse-tls-cert
          mountPath: /etc/altinity-mcp/client.crt
          subPath: clickhouse-client.crt
          readOnly: true
        {{- end }}
        {{- if .Values.clickhouse.tls.key }}
        - name: clickhouse-tls-key
          mountPath: /etc/clickhouse-client/client.key
          subPath: clickhouse-client.key
          readOnly: true
        - name: clickhouse-tls-key
          mountPath: /etc/altinity-mcp/client.key
          subPath: clickhouse-client.key
          readOnly: true
        {{- end }}
  volumes:
    - name: credentials
      secret:
        secretName: {{ include "skills-agent.secretName" . }}
        defaultMode: 0400
    - name: workspace
      emptyDir: {}
    - name: agent-logs
      emptyDir: {}
    - name: clickhouse-client-config
      secret:
        secretName: {{ include "skills-agent.secretName" . }}
        items:
          - key: clickhouse-client-config.xml
            path: clickhouse-client-config.xml
        defaultMode: 0400
    - name: altinity-mcp-config
      secret:
        secretName: {{ include "skills-agent.secretName" . }}
        items:
          - key: altinity-mcp-config.yaml
            path: altinity-mcp-config.yaml
        defaultMode: 0400
    {{- if .Values.clickhouse.tls.ca }}
    - name: clickhouse-tls-ca
      secret:
        secretName: {{ include "skills-agent.secretName" . }}
        items:
          - key: clickhouse-ca.crt
            path: clickhouse-ca.crt
        defaultMode: 0400
    {{- end }}
    {{- if .Values.clickhouse.tls.cert }}
    - name: clickhouse-tls-cert
      secret:
        secretName: {{ include "skills-agent.secretName" . }}
        items:
          - key: clickhouse-client.crt
            path: clickhouse-client.crt
        defaultMode: 0400
    {{- end }}
    {{- if .Values.clickhouse.tls.key }}
    - name: clickhouse-tls-key
      secret:
        secretName: {{ include "skills-agent.secretName" . }}
        items:
          - key: clickhouse-client.key
            path: clickhouse-client.key
        defaultMode: 0400
    {{- end }}
  {{- with .Values.nodeSelector }}
  nodeSelector:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.affinity }}
  affinity:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.tolerations }}
  tolerations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
{{- end }}
